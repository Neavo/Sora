--------------------------------------- 輸入框首字@可快捷密好友-- Author:M---------------------------------------職業顔色值local LOCAL_CLASS_INFO = {}do    if (GetNumClasses) then        local localClass, class        for i = 1, GetNumClasses() do            localClass, class = GetClassInfo(i)            LOCAL_CLASS_INFO[localClass] = RAID_CLASS_COLORS[class] or NORMAL_FONT_COLOR            LOCAL_CLASS_INFO[localClass].class = class        end    endend--按鈕數量local numButton = 12--創建信息框do    local function OnClick(self)        local parent = self:GetParent()        local editBox = ChatEdit_GetLastActiveWindow()        if (self.dataIsBNet) then            editBox:SetAttribute("chatType", "BN_WHISPER")            editBox:SetAttribute("tellTarget", self.dataBName)        else            editBox:SetAttribute("chatType", "WHISPER")            editBox:SetAttribute("tellTarget", self.dataName)        end        ChatEdit_UpdateHeader(editBox)        editBox:SetText(strsub(editBox:GetText(),parent.editPos+1))        ChatEdit_ActivateChat(editBox)        parent:Hide()    end    local function CreateButton(parent, index)        local button = CreateFrame("Button", "ChatAtFriendsFrameButton"..index, parent)        button:SetHighlightTexture("Interface\\Buttons\\UI-Common-MouseHilight", "ADD")        button:SetID(index)        button:SetHeight(26)        button:SetWidth(128)        button:SetScript("OnClick", OnClick)        button.OnClick = OnClick        if (index == 1) then            button:SetPoint("TOP", parent, "TOP", 0, -10)        else            button:SetPoint("TOP", _G["ChatAtFriendsFrameButton"..(index-1)], "BOTTOM", 0, -6)        end        button.icon = button:CreateTexture(nil, "BORDER")        button.icon:SetSize(20, 20)        button.icon:SetPoint("LEFT", 8, 0)        button.icon:SetTexture("Interface\\TargetingFrame\\UI-Classes-Circles")        button.name = button:CreateFontString(nil, "ARTWORK")        button.name:SetFont(UNIT_NAME_FONT, 13, "OUTLINE")        button.name:SetPoint("TOPLEFT", button, "TOPLEFT", 30, 0)        button.name:SetJustifyH("LEFT")        button.name:SetSize(90, 18)        button.area = button:CreateFontString(nil, "ARTWORK")        button.area:SetFont(GameFontNormal:GetFont(), 10, "NORMAL")        button.area:SetPoint("BOTTOMLEFT", button, "BOTTOMLEFT", 30, 0)        button.area:SetJustifyH("LEFT")        button.area:SetSize(90, 12)        button.area:SetTextColor(1, 0.82, 0, 0.8)        button.level = button:CreateFontString(nil, "ARTWORK")        button.level:SetFont(GameFontNormal:GetFont(), 10, "OUTLINE")        button.level:SetPoint("LEFT", -2, -6)        button.level:SetSize(40, 40)        button.level:SetTextColor(1, 0.82, 0)    end    local frame = CreateFrame("Frame", "ChatAtFriendsFrame", UIParent, "BackdropTemplate")    frame:Hide()    frame:SetClampedToScreen(true)    frame:SetFrameStrata("DIALOG")    frame:SetSize(136, 500)    frame:SetBackdrop({        bgFile   = "Interface\\Tooltips\\UI-Tooltip-Background",        edgeFile = "Interface\\Tooltips\\UI-Tooltip-Border", tile = true, tileSize = 8, edgeSize = 8,        insets   = { left = 2, right = 2, top = 2, bottom = 2 }    })    frame:SetBackdropColor(0, 0, 0, 0.8)    frame:SetBackdropBorderColor(1, 1, 1, 0.8)    for i = 1, numButton do CreateButton(frame, i) endend--获取单个在玩WOW的在线好友信息local function GetWowFriendAccountInfo(friendIndex)    local gameAccountInfo    local accountInfo = C_BattleNet.GetFriendAccountInfo(friendIndex)    local numGameAccounts = C_BattleNet.GetFriendNumGameAccounts(friendIndex)    if (numGameAccounts > 1) then        for i = 1, numGameAccounts do            gameAccountInfo = C_BattleNet.GetFriendGameAccountInfo(friendIndex, i)            if (gameAccountInfo and gameAccountInfo.clientProgram == BNET_CLIENT_WOW) then                return {                        bname = accountInfo.accountName,                        name  = gameAccountInfo.characterName,                        level = gameAccountInfo.characterLevel,                        class = gameAccountInfo.className,                        area  = gameAccountInfo.areaName,                        faction = gameAccountInfo.factionName,                         isBNet  = true,                      }            end        end    elseif (accountInfo and accountInfo.gameAccountInfo.clientProgram == BNET_CLIENT_WOW) then        return {                bname = accountInfo.accountName,                name  = accountInfo.gameAccountInfo.characterName,                level = accountInfo.gameAccountInfo.characterLevel,                class = accountInfo.gameAccountInfo.className,                area  = accountInfo.gameAccountInfo.areaName,                faction = accountInfo.gameAccountInfo.factionName,                 isBNet = true,              }    endend--獲取好友信息local function ListFriends(text)    local friends = {}    local info, _    --角色好友    local numWoWTotal = C_FriendList.GetNumFriends()    if (numWoWTotal > 0) then        faction = UnitFactionGroup("player")        for id = 1, numWoWTotal do            info = C_FriendList.GetFriendInfoByIndex(id)            if (info.connected) then                tinsert(friends, { name = info.name, level = info.level, class = info.className, area = info.area, faction = faction, isBNet = false, })            end        end    end    --戰網好友    local numBNetTotal, numBNetOnline, numBNetFavorite, numBNetFavoriteOnline = BNGetNumFriends()    local bnetFriendIndex = 0    for i = 1, numBNetFavorite do		bnetFriendIndex = bnetFriendIndex + 1        info = GetWowFriendAccountInfo(bnetFriendIndex)        if (info) then tinsert(friends, info) end	end    for i = 1, numBNetOnline - numBNetFavoriteOnline do		bnetFriendIndex = bnetFriendIndex + 1		info = GetWowFriendAccountInfo(bnetFriendIndex)        if (info) then tinsert(friends, info) end	end    --好友太多的話自動啓用關鍵字匹配    if (#friends > numButton) then        text = text:gsub("@", "")        if (text ~= "") then            text = text:gsub("^%l", string.upper)            local t = {}            for _, v in ipairs(friends) do                if (strfind(v.name, text)) then                    tinsert(t, v)                end            end            if (#t > 0) then friends = t end        end    end    return friendsend--设置按钮高亮local function SetHighlightButton(index)    for i = 1, numButton do        if (i == index) then            _G["ChatAtFriendsFrameButton"..i]:LockHighlight()        else            _G["ChatAtFriendsFrameButton"..i]:UnlockHighlight()        end    endend--顯示好友信息框local function ChatAtFriendsFrame_Show(self, text)    local friends = ListFriends(text)    local faction = UnitFactionGroup("player")    local position = self.GetCursorPosition and self:GetCursorPosition() or 0    local button, info    local index = 1    if (#friends == 0) then return ChatAtFriendsFrame:Hide() end    while (friends[index] and index <= numButton) do        info = LOCAL_CLASS_INFO[friends[index].class or ""]        button = _G["ChatAtFriendsFrameButton"..index]        button.name:SetText(friends[index].name)        button.area:SetText(friends[index].area)        button.level:SetText(friends[index].level)		button.name:SetTextColor(info.r, info.g, info.b)        if (not info.class or info.class == "") then            button.icon:SetTexture("Interface\\TargetingFrame\\UI-PVP-"..friends[index].faction)            button.icon:SetTexCoord(0, 44/64, 0, 44/64)        elseif (faction == friends[index].faction) then            button.icon:SetTexture("Interface\\TargetingFrame\\UI-Classes-Circles")            button.icon:SetTexCoord(unpack(CLASS_ICON_TCOORDS[info.class]))        else            button.icon:SetTexture("Interface\\TargetingFrame\\UI-PVP-"..friends[index].faction)            button.icon:SetTexCoord(0, 44/64, 0, 44/64)        end        button.dataName = friends[index].name        button.dataIsBNet = friends[index].isBNet        button.dataBName = friends[index].bname        button:Show()        index = index + 1    end        ChatAtFriendsFrame.selectedIndex = 1    ChatAtFriendsFrame.totalIndex = index - 1    SetHighlightButton(1)    ChatAtFriendsFrame:SetHeight((index-1)*32+20)    while (_G["ChatAtFriendsFrameButton"..index]) do        _G["ChatAtFriendsFrameButton"..index]:Hide()        index = index + 1    end    ChatAtFriendsFrame.editPos = position    ChatAtFriendsFrame:SetPoint("BOTTOMLEFT", self, "TOPLEFT", position*8+40, -4)    ChatAtFriendsFrame:Show()end--隱藏好友信息框local function ChatAtFriendsFrame_Hide()    ChatAtFriendsFrame:Hide()end--功能附到聊天框 多于3字不顯示hooksecurefunc("ChatEdit_OnTextChanged", function(self, userInput)    local text = self:GetText()    if (userInput) then        if (strfind(text, "^%s*@%w-") and self:GetUTF8CursorPosition() <= 4) then            ChatAtFriendsFrame_Show(self, text)        else            ChatAtFriendsFrame_Hide()        end    endend)--ESE或输入清理时隐藏好友信息框if (ChatEdit_ClearChat) then    hooksecurefunc("ChatEdit_ClearChat", function(editBox) ChatAtFriendsFrame_Hide() end)end--这里需要延时隐藏if (ChatEdit_OnEditFocusLost) then    hooksecurefunc("ChatEdit_OnEditFocusLost", function(editBox)        C_Timer.After(.2, ChatAtFriendsFrame_Hide)    end)end--上下箭头可选好友local function OnArrowPressed(self, keyPress)    if (not ChatAtFriendsFrame:IsShown()) then        return    end    if (keyPress == "UP") then        ChatAtFriendsFrame.selectedIndex = ChatAtFriendsFrame.selectedIndex - 1    elseif (keyPress == "DOWN") then        ChatAtFriendsFrame.selectedIndex = ChatAtFriendsFrame.selectedIndex + 1    end    if (ChatAtFriendsFrame.selectedIndex > ChatAtFriendsFrame.totalIndex) then        ChatAtFriendsFrame.selectedIndex = 1    end    if (ChatAtFriendsFrame.selectedIndex <= 0) then        ChatAtFriendsFrame.selectedIndex = ChatAtFriendsFrame.totalIndex    end    SetHighlightButton(ChatAtFriendsFrame.selectedIndex)endfor i = 1, NUM_CHAT_WINDOWS do    local editbox = _G["ChatFrame"..i.."EditBox"]    editbox:HookScript("OnArrowPressed", OnArrowPressed)end--Hacklocal Orig_ChatEdit_OnEnterPressed = ChatEdit_OnEnterPressedfunction ChatEdit_OnEnterPressed(self)    if (ChatAtFriendsFrame:IsShown()) then        _G["ChatAtFriendsFrameButton"..ChatAtFriendsFrame.selectedIndex]:OnClick()    else        Orig_ChatEdit_OnEnterPressed(self)    end    ChatAtFriendsFrame_Hide()end---------------------------------------密语战网时,显示好友WOW角色信息-------------------------------------local function ShowBNetWoWAccountInfo(editBox, info)    local bname = editBox:GetAttribute("tellTarget")    if (info and info.bname == bname) then        local classInfo = LOCAL_CLASS_INFO[info.class]        editBox.nametip.name:SetText(info.name)        editBox.nametip.level:SetText(info.level)        editBox.nametip.name:SetTextColor(classInfo.r, classInfo.g, classInfo.b)        if (not classInfo.class or classInfo.class == "") then            editBox.nametip.icon:SetTexture("Interface\\TargetingFrame\\UI-PVP-"..info.faction)            editBox.nametip.icon:SetTexCoord(0, 44/64, 0, 44/64)        elseif (editBox.nametip.faction == info.faction) then            editBox.nametip.icon:SetTexture("Interface\\TargetingFrame\\UI-Classes-Circles")            editBox.nametip.icon:SetTexCoord(unpack(CLASS_ICON_TCOORDS[classInfo.class]))        else            editBox.nametip.icon:SetTexture("Interface\\TargetingFrame\\UI-PVP-"..info.faction)            editBox.nametip.icon:SetTexCoord(0, 44/64, 0, 44/64)        end        editBox.nametip:Show()        return true    endendhooksecurefunc("ChatEdit_UpdateHeader", function(editBox)    if (not editBox.nametip) then        editBox.nametip = CreateFrame("Frame", nil, editBox)        editBox.nametip:SetPoint("TOPLEFT", editBox, "TOPLEFT", 40, 12)        editBox.nametip:SetSize(136, 16)        editBox.nametip.icon = editBox.nametip:CreateTexture(nil, "BORDER")        editBox.nametip.icon:SetSize(15, 15)        editBox.nametip.icon:SetPoint("LEFT", 8, 0)        editBox.nametip.icon:SetTexture("Interface\\TargetingFrame\\UI-Classes-Circles")        editBox.nametip.name = editBox.nametip:CreateFontString(nil, "ARTWORK")        editBox.nametip.name:SetFont(UNIT_NAME_FONT, 14, "OUTLINE")        editBox.nametip.name:SetPoint("LEFT", editBox.nametip, "LEFT", 25, 0)        editBox.nametip.name:SetJustifyH("LEFT")        editBox.nametip.name:SetSize(128, 16)        editBox.nametip.level = editBox.nametip:CreateFontString(nil, "ARTWORK")        editBox.nametip.level:SetFont(GameFontNormal:GetFont(), 9, "OUTLINE")        editBox.nametip.level:SetPoint("LEFT", -2, -4)        editBox.nametip.level:SetSize(40, 14)        editBox.nametip.level:SetTextColor(1, 0.82, 0)        editBox.nametip.faction = UnitFactionGroup("player")    end    if (editBox:GetAttribute("chatType") == "BN_WHISPER") then        local numBNetTotal, numBNetOnline, numBNetFavorite, numBNetFavoriteOnline = BNGetNumFriends()        local bnetFriendIndex = 0        for i = 1, numBNetFavorite do            bnetFriendIndex = bnetFriendIndex + 1            if (ShowBNetWoWAccountInfo(editBox,GetWowFriendAccountInfo(bnetFriendIndex))) then                 return            end        end        for i = 1, numBNetOnline - numBNetFavoriteOnline do            bnetFriendIndex = bnetFriendIndex + 1            if (ShowBNetWoWAccountInfo(editBox,GetWowFriendAccountInfo(bnetFriendIndex))) then                 return            end        end    else        editBox.nametip:Hide()    endend)